<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TH8 Cash Flow Engine: Deep Dive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #0F172A; color: #E2E8F0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        .section-tab {
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            opacity: 0.6;
        }
        .section-tab.active {
            border-color: #10B981;
            opacity: 1;
            color: #10B981;
        }

        .data-pipe {
            position: relative;
            overflow: hidden;
        }
        .data-flow-anim {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.2), transparent);
            animation: flow 2s infinite linear;
        }
        @keyframes flow { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        /* Code Block Styling */
        .code-block {
            background: #1E293B;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            overflow-x: auto;
            color: #94A3B8;
        }
        .key { color: #7DD3FC; }
        .string { color: #A5F3FC; }
        .number { color: #FCA5A5; }
        .comment { color: #475569; font-style: italic; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- HEADER -->
    <header class="bg-slate-900 border-b border-slate-800 p-6 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-emerald-600 rounded-lg flex items-center justify-center font-bold text-white text-lg">TH8</div>
                <div>
                    <h1 class="font-bold text-white text-lg">Cash Flow Engine <span class="text-xs bg-slate-800 text-slate-400 px-2 py-0.5 rounded border border-slate-700 ml-2">Architecture View</span></h1>
                    <p class="text-xs text-slate-400">Process Visualization: Data -> Logic -> Action</p>
                </div>
            </div>
            <div class="flex gap-6 text-sm font-bold">
                <button onclick="setStep(1)" id="tab-1" class="section-tab active pb-1">1. Data Context</button>
                <button onclick="setStep(2)" id="tab-2" class="section-tab pb-1">2. Brain & Logic</button>
                <button onclick="setStep(3)" id="tab-3" class="section-tab pb-1">3. Output & Audit</button>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto w-full p-6">

        <!-- STEP 1: DATA CONTEXT (INPUTS) -->
        <section id="step-1" class="space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Source 1: SAP -->
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 relative group">
                    <div class="absolute -top-3 left-6 bg-blue-900 text-blue-200 text-[10px] px-2 py-1 rounded border border-blue-700">Internal Source</div>
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="database" class="text-blue-500"></i> SAP / ERP Data</h3>
                    <p class="text-xs text-slate-400 mb-4">ดึงข้อมูล Invoice ที่ Approved แล้ว และสถานะการเงินบริษัท</p>
                    <div class="code-block">
<span class="key">"erp_context"</span>: {
  <span class="key">"invoice_id"</span>: <span class="string">"INV-8891"</span>,
  <span class="key">"amount"</span>: <span class="number">5000000.00</span>,
  <span class="key">"due_date"</span>: <span class="string">"2024-08-30"</span>, <span class="comment">// 60 days left</span>
  <span class="key">"vendor_id"</span>: <span class="string">"V-001"</span>,
  <span class="key">"buyer_cash_on_hand"</span>: <span class="number">150000000.00</span>
}
                    </div>
                    <div class="absolute bottom-6 right-0 w-8 h-1 bg-blue-500 data-flow-anim"></div>
                </div>

                <!-- Source 2: External Signals -->
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 relative group">
                    <div class="absolute -top-3 left-6 bg-purple-900 text-purple-200 text-[10px] px-2 py-1 rounded border border-purple-700">External Source</div>
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="globe" class="text-purple-500"></i> Market Intelligence</h3>
                    <p class="text-xs text-slate-400 mb-4">ดึงข้อมูลความเสี่ยง Vendor และดอกเบี้ยตลาด</p>
                    <div class="code-block">
<span class="key">"market_signals"</span>: {
  <span class="key">"risk_score"</span>: <span class="number">7.5</span>, <span class="comment">// D&B Score (High risk)</span>
  <span class="key">"sector_trend"</span>: <span class="string">"LIQUIDITY_CRUNCH"</span>,
  <span class="key">"bank_deposit_rate"</span>: <span class="number">1.50</span>, <span class="comment">// % per year</span>
  <span class="key">"buyer_cost_of_capital"</span>: <span class="number">4.50</span> <span class="comment">// % (OD Rate)</span>
}
                    </div>
                    <div class="absolute bottom-6 right-0 w-8 h-1 bg-purple-500 data-flow-anim"></div>
                </div>

                <!-- Merged Context -->
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 flex flex-col justify-center items-center text-center shadow-xl shadow-emerald-900/20">
                    <div class="w-16 h-16 bg-slate-900 rounded-full flex items-center justify-center mb-4 border border-emerald-500/50 animate-pulse">
                        <i data-lucide="layers" class="w-8 h-8 text-emerald-400"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white">Context Vector</h3>
                    <p class="text-xs text-slate-400 mt-2 px-4">
                        ข้อมูลทั้งหมดถูกรวมเป็น JSON Context ขนาดใหญ่ เพื่อส่งต่อให้ AI และ Calculation Engine
                    </p>
                    <button onclick="setStep(2)" class="mt-6 bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                        Process Data <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- STEP 2: BRAIN & LOGIC (The Core) -->
        <section id="step-2" class="hidden space-y-8">
            
            <!-- Logic Flow Diagram -->
            <div class="flex flex-col md:flex-row gap-4 h-full">
                
                <!-- 1. Rule Engine (Hard Constraints) -->
                <div class="w-full md:w-1/3 bg-slate-900 border border-slate-800 rounded-xl p-6">
                    <h3 class="text-sm font-bold text-amber-400 uppercase mb-4 flex items-center gap-2"><i data-lucide="shield-alert" class="w-4 h-4"></i> 1. Rule-Based Gate</h3>
                    <p class="text-xs text-slate-400 mb-4">ด่านแรก: กรองด้วยกฎเหล็กทางบัญชี (YAML)</p>
                    <div class="code-block h-64 overflow-y-auto">
<span class="comment"># policy_finance_v2.yaml</span>

<span class="key">- rule_id</span>: <span class="string">"CASH_BUFFER_CHECK"</span>
  <span class="key">condition</span>: "cash_balance > 50M"
  <span class="key">result</span>: <span class="string">"PASS"</span> <span class="comment">// (150M > 50M)</span>

<span class="key">- rule_id</span>: <span class="string">"MIN_YIELD_CHECK"</span>
  <span class="key">condition</span>: "target_apr > cost_of_capital + 2%"
  <span class="key">formula</span>: "(discount / days) * 360"
  <span class="key">status</span>: <span class="string">"ACTIVE"</span>
                    </div>
                    <div class="mt-4 p-3 bg-emerald-900/20 border border-emerald-500/30 rounded text-xs text-emerald-400 text-center font-bold">
                        STATUS: PASSED (Proceed to Optimization)
                    </div>
                </div>

                <!-- 2. Optimization Formula (Math) -->
                <div class="w-full md:w-1/3 bg-slate-900 border border-slate-800 rounded-xl p-6">
                    <h3 class="text-sm font-bold text-sky-400 uppercase mb-4 flex items-center gap-2"><i data-lucide="calculator" class="w-4 h-4"></i> 2. Optimization Formula</h3>
                    <p class="text-xs text-slate-400 mb-4">คำนวณ APR เพื่อหาจุดคุ้มทุน (Breakeven)</p>
                    
                    <div class="bg-slate-800 p-4 rounded-lg mb-4 text-center">
                        <p class="text-[10px] text-slate-500 mb-1">Annualized Yield Formula</p>
                        <p class="text-sm font-mono text-white">Yield = <span class="text-sky-400">(Disc% / (1-Disc%))</span> × <span class="text-emerald-400">(360 / Days)</span></p>
                    </div>

                    <div class="relative h-40 w-full">
                        <canvas id="yieldChart"></canvas>
                    </div>
                    
                    <div class="mt-2 flex justify-between text-xs font-mono">
                        <div class="text-slate-400">Days: <span class="text-white">45</span></div>
                        <div class="text-slate-400">Discount: <span class="text-white">1.5%</span></div>
                        <div class="text-emerald-400 font-bold">APR: ~12.1%</div>
                    </div>
                </div>

                <!-- 3. LLM Reasoning (Soft Skills) -->
                <div class="w-full md:w-1/3 bg-slate-900 border border-slate-800 rounded-xl p-6">
                    <h3 class="text-sm font-bold text-purple-400 uppercase mb-4 flex items-center gap-2"><i data-lucide="brain-circuit" class="w-4 h-4"></i> 3. LLM Strategy Agent</h3>
                    <p class="text-xs text-slate-400 mb-4">ใช้ AI ประเมินจิตวิทยา Vendor และร่างข้อเสนอ</p>
                    
                    <div class="code-block h-64 overflow-y-auto whitespace-pre-wrap">
<span class="comment">// PROMPT INJECTED TO LLM</span>
<span class="key">Role:</span> Treasury Expert
<span class="key">Context:</span> Vendor "Siam Steel" is in "Construction" sector (High Liquidity Stress).
<span class="key">History:</span> Usually accepts 2% discount.
<span class="key">Goal:</span> Maximize yield but keep acceptance prob > 80%.

<span class="comment">// LLM OUTPUT</span>
<span class="key">Strategy:</span> "Aggressive Offer"
<span class="key">Reasoning:</span> "Sector news indicates cash shortage. Vendor likely to accept lower discount for immediate cash."
<span class="key">Rec_Discount:</span> 1.5% (instead of usual 2%)
<span class="key">Prob_Accept:</span> 85%
                    </div>
                </div>

            </div>

            <div class="text-center">
                <button onclick="setStep(3)" class="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-lg font-bold shadow-lg shadow-indigo-900/50 flex items-center gap-2 mx-auto">
                    Generate Final Offer <i data-lucide="arrow-down" class="w-4 h-4"></i>
                </button>
            </div>
        </section>

        <!-- STEP 3: OUTPUT & AUDIT -->
        <section id="step-3" class="hidden space-y-8">
            <div class="max-w-4xl mx-auto">
                
                <!-- Action Card -->
                <div class="bg-white rounded-xl shadow-2xl overflow-hidden mb-8">
                    <div class="bg-emerald-600 px-6 py-4 flex justify-between items-center text-white">
                        <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="mail" class="w-5 h-5"></i> Offer Ready to Send</h3>
                        <span class="bg-emerald-700 px-3 py-1 rounded-full text-xs font-mono border border-emerald-500">PROFIT: ฿75,000</span>
                    </div>
                    <div class="p-8 grid grid-cols-3 gap-8">
                        <div class="col-span-2 space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase">To Vendor</label>
                                <p class="text-slate-800 font-bold">Siam Steel Co., Ltd. (finance@siamsteel.com)</p>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase">Email Content (AI Drafted)</label>
                                <div class="bg-slate-50 p-4 rounded border border-slate-200 text-sm text-slate-600 mt-1 font-sans">
                                    <p class="mb-2">Dear Khun Somchai,</p>
                                    <p class="mb-2">Regarding INV-8891 (Due: 30 Aug), we can process an <strong>immediate payment tomorrow</strong> if you agree to a <strong>1.5% discount</strong>.</p>
                                    <p class="mb-2">You will receive: <strong>4,925,000 THB</strong> (Cash in hand immediately).</p>
                                    <p>Please click the link below to accept.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-span-1 bg-slate-50 p-4 rounded-xl border border-slate-200 text-center">
                            <p class="text-xs text-slate-500 mb-2">Effective APR Yield</p>
                            <p class="text-3xl font-bold text-emerald-600 mb-1">12.1%</p>
                            <p class="text-[10px] text-slate-400">(vs Bank Rate 1.5%)</p>
                            
                            <div class="mt-6 pt-6 border-t border-slate-200">
                                <button class="w-full bg-slate-900 text-white py-2 rounded font-bold hover:bg-slate-800 transition">Send Offer</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audit Log JSON -->
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-6">
                    <h3 class="text-sm font-bold text-slate-400 uppercase mb-4 flex items-center gap-2"><i data-lucide="file-code" class="w-4 h-4"></i> Immutable Audit Log (Generated)</h3>
                    <div class="code-block">
{
  <span class="key">"event_id"</span>: <span class="string">"TXN-2024-9912"</span>,
  <span class="key">"timestamp"</span>: <span class="string">"2024-06-15T10:30:00Z"</span>,
  <span class="key">"action_type"</span>: <span class="string">"OFFER_GENERATED"</span>,
  <span class="key">"parameters"</span>: {
    <span class="key">"invoice_amount"</span>: <span class="number">5000000</span>,
    <span class="key">"discount_rate"</span>: <span class="number">0.015</span>,
    <span class="key">"days_accelerated"</span>: <span class="number">45</span>
  },
  <span class="key">"logic_trace"</span>: {
    <span class="key">"rule_engine"</span>: <span class="string">"PASS"</span>,
    <span class="key">"ai_model"</span>: <span class="string">"GPT-4o-Enterprise"</span>,
    <span class="key">"rationale"</span>: <span class="string">"Vendor sector stress indicates high acceptance probability."</span>
  },
  <span class="key">"integrity_hash"</span>: <span class="string">"sha256:a91..."</span>
}
                    </div>
                </div>

            </div>
        </section>

    </main>

    <script>
        lucide.createIcons();

        function setStep(step) {
            // Hide all sections
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.section-tab').forEach(el => el.classList.remove('active'));

            // Show selected
            document.getElementById(`step-${step}`).classList.remove('hidden');
            document.getElementById(`tab-${step}`).classList.add('active');

            // Render Chart if Step 2
            if(step === 2) renderChart();
        }

        function renderChart() {
            const ctx = document.getElementById('yieldChart').getContext('2d');
            // Check if chart exists
            if(window.myChart) window.myChart.destroy();

            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['10 Days', '20 Days', '30 Days', '40 Days', '50 Days', '60 Days'],
                    datasets: [{
                        label: 'APR Yield (%)',
                        data: [5, 8, 10, 11.5, 12.1, 12.5], // Dummy curve
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            grid: { color: '#334155' },
                            ticks: { color: '#94A3B8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94A3B8' }
                        }
                    }
                }
            });
        }

        // Init
        setStep(1);
    </script>
</body>
</html>